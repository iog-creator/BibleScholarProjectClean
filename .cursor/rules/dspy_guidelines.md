# DSPy Usage and Generation Guidelines

## Purpose
// ... existing code ...
### Key Files
- `src/utils/dspy_collector.py` - Core collection system
- `scripts/generate_dspy_training_data.py` - Main generation script
- `scripts/refresh_dspy_data.py` - Command-line utility for status/refresh
- `scripts/enhance_dspy_training.py` - Script for enhancing training data
- `scripts/log_user_interactions.py` - User interaction logging utilities
- `scripts/data/expand_bible_trivia_dataset.py` - Consolidates and preprocesses Q&A datasets from various external formats (e.g., Alpaca JSONL, MushroomGecko multiple-choice JSONL) into a unified instruction/response format suitable for general DSPy training. It handles format transformation, metadata enrichment, and deduplication. See `docs/guides/non_synthetic_training_workflow.md` for detailed usage.
- `data/processed/dspy_training_data/` - Generated datasets

## Implementation Guidelines
// ... existing code ... 

## Required Validation

All DSPy training data must be validated using:
// ... existing code ...

## LM Output Parsing and JSON Responses

When working with DSPy modules like `dspy.Predict` and `dspy.ChainOfThought`, be aware of how LM responses are parsed, especially when not using standard, well-vetted LMs (e.g., OpenAI through `dspy.OpenAI`) or when using custom/dummy LMs for testing.

**Key Observations:**

1.  **JSON-Mode Expectation:** DSPy's adapters (e.g., `ChatAdapter` often used by `Predict` and `ChainOfThought`) may expect the Language Model's string output to be a **fully formed JSON object string**.
    *   This is particularly true if the prompt templates generated by DSPy (which can be observed by inspecting the `prompt` or `messages` argument passed to the LM's `__call__` or `basic_request` method) explicitly instruct the LM to "Respond with a JSON object".
    *   Even if a module like `dspy.ChainOfThought` might traditionally parse plain text "Thought: \n OutputField: " formats, it can switch to expecting a JSON object if the underlying adapter configuration or LM type leads it to JSON mode.

2.  **DummyLM and JSON:** When implementing a `DummyLM` for structural testing:
    *   Ensure the `basic_request` (or equivalent method that produces the raw LM output string) returns a string that is a valid JSON.
    *   For `dspy.Predict(SignatureName)` where `SignatureName` has an output field `out_field`, the `DummyLM` should return something like:
        `json.dumps({"out_field": "dummy value"})`
    *   For `dspy.ChainOfThought(SignatureName)` where `SignatureName` has an output field `out_field`, the `DummyLM` should return something like:
        `json.dumps({"reasoning": "dummy reasoning", "out_field": "dummy value"})`

3.  **Stringified JSON within JSON:** If a `dspy.Signature`'s `OutputField` has a description indicating it should be a "JSON string" (e.g., `cross_references_json = dspy.OutputField(desc="A JSON string representing a list...")`), then the value for this field within the main JSON response from the LM must itself be a string containing valid JSON.
    *   Example for `ChainOfThought` with such a field:
        ```python
        # In DummyLM or real LM output construction
        payload = {
            "reasoning": "Dummy thought.",
            "cross_references_json": json.dumps([{"ref": "...", "text": "..."}]) # The value is a string
        }
        final_lm_output_string = json.dumps(payload)
        ```

4.  **Debugging Tip:** If you encounter `ValueError`s related to `Expected dict_keys(...) but got dict_keys([])` or `Expected a JSON object but parsed a <class 'str'>`, inspect the prompt sent to the LM and ensure your LM (especially a dummy one) is providing output in the exact format (likely JSON) the adapter now expects. Adding debug prints to your LM's request handler is invaluable.

## Usage Guidelines

### Checking Data Status
// ... existing code ... 

<!-- NOTE: Contextual Insights feature now bypasses DSPy JSONAdapter and uses direct LM Studio minimal integration. DSPy parsing guidelines below apply to other modules and future enhancements. -->